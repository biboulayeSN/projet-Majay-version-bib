<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MAJAY</title>
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body class="dashboard-page">
    <header class="dashboard-header">
        <div class="dashboard-header-content">
            <div class="dashboard-logo">ğŸ›ï¸ MAJAY</div>
            <nav class="dashboard-nav" id="mainNav">
                <a href="dashboard.html" class="nav-link active">ğŸ“Š Dashboard</a>
                <a href="produits.html" class="nav-link">ğŸ“¦ Produits</a>
                <a href="commandes.html" class="nav-link">ğŸ›’ Commandes</a>
                <a href="clients.html" class="nav-link">ğŸ‘¥ Clients</a>
                <a href="analytics.html" class="nav-link">ğŸ“ˆ Analytics</a>
                <a href="abonnements.html" class="nav-link">ğŸ’³ Abonnements</a>
                <a href="profil.html" class="nav-link">âš™ï¸ Profil</a>
            </nav>
            <div style="display: flex; gap: var(--spacing-md); align-items: center;">
                <span class="badge" id="userPlan">FREE</span>
                <button onclick="window.authMajay.deconnexion()" class="btn btn-outline btn-sm" title="DÃ©connexion">ğŸšª DÃ©connexion</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Bonjour, <span id="userName">Vendeur</span> ğŸ‘‹</h1>
                <p class="page-subtitle">Voici un aperÃ§u de votre activitÃ©</p>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: var(--spacing-2xl);" class="fade-in">
                <div class="loader"></div>
                <p style="margin-top: var(--spacing-md); color: var(--color-text-light);">Chargement des statistiques...</p>
            </div>
        </div>

        <div class="actions-grid">
            <div class="action-card" onclick="window.location.href='produits.html'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin-bottom: 10px;">GÃ©rer mes produits</h3>
                        <p style="color: #718096;">Ajouter, modifier ou supprimer</p>
                    </div>
                    <div style="font-size: 2.5em;">ğŸ“¦</div>
                </div>
            </div>

            <div class="action-card" onclick="copierLien()">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin-bottom: 10px;">Partager ma boutique</h3>
                        <p style="color: #718096;">Copier le lien</p>
                    </div>
                    <div style="font-size: 2.5em;">ğŸ”—</div>
                </div>
            </div>

            <div class="action-card" onclick="window.location.href='commandes.html'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin-bottom: 10px;">Mes commandes</h3>
                        <p style="color: #718096;">Historique et suivi</p>
                    </div>
                    <div style="font-size: 2.5em;">ğŸ›’</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>ğŸ“ˆ Commandes rÃ©centes</h2>
            </div>
            <div class="card-body" id="commandesRecentes">
                <div class="empty-state">
                    <div class="loader"></div>
                    <p style="margin-top: var(--spacing-md);">Chargement...</p>
                </div>
            </div>
            <div class="card-footer" style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                <button onclick="upgradePlan('pro')" class="btn btn-primary btn-sm">ğŸš€ Passer Pro</button>
                <button onclick="upgradePlan('entreprise')" class="btn btn-primary btn-sm">ğŸ’ Passer Entreprise</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase } from "../js/config.js";
        import { authMajay } from "../js/auth.js";

        const session = authMajay.getSession();
        if (!session) window.location.href = 'connexion.html';
        
        window.upgradePlan = function(plan) {
            const msg = `
Bonjour,
Je souhaite passer au plan ${plan.toUpperCase()}.

Boutique : ${session.store_name}
TÃ©lÃ©phone : ${session.phone}
Slug : ${session.store_slug}
`;
            window.open(
                "https://wa.me/221771234567?text=" + encodeURIComponent(msg),
                "_blank"
            );
        };

        document.getElementById('userName').textContent = session.store_name || session.full_name;
        document.getElementById('userPlan').textContent = (session.subscription_plan || 'free').toUpperCase();
        document.getElementById('userPlan').className = `badge badge-${session.subscription_plan || 'free'}`;

        // Afficher les liens conditionnels selon le plan
        const plan = session.subscription_plan || 'free';
        if (plan === 'entreprise') {
            // Ajouter les liens pour plan Entreprise
            const nav = document.getElementById('mainNav');
            const equipeLink = document.createElement('a');
            equipeLink.href = 'equipe.html';
            equipeLink.className = 'nav-link';
            equipeLink.textContent = 'ğŸ‘¥ Ã‰quipe';
            nav.insertBefore(equipeLink, nav.lastElementChild);
            
            const multiLink = document.createElement('a');
            multiLink.href = 'multi-boutiques.html';
            multiLink.className = 'nav-link';
            multiLink.textContent = 'ğŸª Multi-Boutiques';
            nav.insertBefore(multiLink, nav.lastElementChild);
        }

        async function chargerStats() {
            try {
                const { data: produits } = await supabase
                    .from('products')
                    .select('id')
                    .eq('store_id', session.store_id)
                    .eq('is_active', true);

                const { data: commandes } = await supabase
                    .from('orders')
                    .select('total')
                    .eq('store_id', session.store_id);

                // Compter les vues depuis click_events
                const { count: totalVues } = await supabase
                    .from('click_events')
                    .select('*', { count: 'exact', head: true })
                    .eq('store_id', session.store_id)
                    .eq('event_type', 'view');

                const nbProduits = produits?.length || 0;
                const nbCommandes = commandes?.length || 0;
                const totalVentes = commandes?.reduce((sum, c) => sum + (parseInt(c.total) || 0), 0) || 0;

                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card slide-up" style="animation-delay: 0.1s;">
                        <div class="stat-icon">ğŸ“¦</div>
                        <div class="stat-label">Produits actifs</div>
                        <div class="stat-value">${nbProduits}</div>
                    </div>
                    <div class="stat-card slide-up" style="animation-delay: 0.2s;">
                        <div class="stat-icon">ğŸ›’</div>
                        <div class="stat-label">Commandes</div>
                        <div class="stat-value">${nbCommandes}</div>
                    </div>
                    <div class="stat-card slide-up" style="animation-delay: 0.3s;">
                        <div class="stat-icon">ğŸ’°</div>
                        <div class="stat-label">Ventes totales</div>
                        <div class="stat-value">${totalVentes.toLocaleString()}</div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-light); margin-top: var(--spacing-xs);">FCFA</div>
                    </div>
                    <div class="stat-card slide-up" style="animation-delay: 0.4s;">
                        <div class="stat-icon">ğŸ‘ï¸</div>
                        <div class="stat-label">Vues catalogue</div>
                        <div class="stat-value">${totalVues}</div>
                    </div>
                `;
            } catch (error) {
                console.error(error);
            }
        }

        async function chargerCommandes() {
            const { data } = await supabase
                .from('orders')
                .select('*')
                .eq('store_id', session.store_id)
                .order('created_at', { ascending: false })
                .limit(5);

            if (!data || data.length === 0) {
                document.getElementById('commandesRecentes').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ›’</div>
                        <h3>Aucune commande</h3>
                        <p>Vos commandes apparaÃ®tront ici une fois que vos clients commenceront Ã  commander</p>
                    </div>
                `;
                return;
            }

            document.getElementById('commandesRecentes').innerHTML = `
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Produits</th>
                                <th>Total</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(cmd => {
                                const itemsCount = Array.isArray(cmd.items) ? cmd.items.length : 0;
                                const statusClass = cmd.status === 'delivered' ? 'success' : 
                                                   cmd.status === 'confirmed' ? 'success' : 
                                                   cmd.status === 'cancelled' ? 'danger' : 'warning';
                                const statusNames = {
                                    pending: 'En attente',
                                    confirmed: 'ConfirmÃ©e',
                                    preparing: 'En prÃ©paration',
                                    ready: 'PrÃªte',
                                    delivered: 'LivrÃ©e',
                                    cancelled: 'AnnulÃ©e'
                                };
                                return `
                                <tr>
                                    <td>${new Date(cmd.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                                    <td>${itemsCount} article(s)</td>
                                    <td style="font-weight: 700; color: var(--color-success);">${parseInt(cmd.total || 0).toLocaleString()} ${cmd.currency || 'XOF'}</td>
                                    <td><span class="badge badge-${statusClass}">${statusNames[cmd.status] || cmd.status || 'pending'}</span></td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        window.copierLien = async function() {
            // Nouveau format : www.site.com/slug-boutique
            const lien = window.location.origin + '/' + session.store_slug;
            try {
                await navigator.clipboard.writeText(lien);
                const { showSuccess } = await import('../js/notifications.js');
                showSuccess('Lien copiÃ© ! Partagez-le avec vos clients');
            } catch (err) {
                const { showError } = await import('../js/notifications.js');
                showError('Erreur lors de la copie');
            }
        };

        chargerStats();
        chargerCommandes();
    </script>
</body>
</html>