<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Vendeurs - MAJAY Admin</title>
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <style>
        body {
            background: #f7fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .admin-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .admin-header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        .dashboard-logo {
            font-size: 1.5em;
            font-weight: bold;
        }
        .admin-nav {
            display: flex;
            gap: 15px;
        }
        .admin-nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .admin-nav a:hover {
            background: rgba(255,255,255,0.1);
        }
        .admin-nav a.active {
            background: rgba(255,255,255,0.2);
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 30px;
        }
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-active {
            background: #d4edda;
            color: #155724;
        }
        .badge-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .badge-free {
            background: #e3f2fd;
            color: #1565c0;
        }
        .badge-pro {
            background: #fff3e0;
            color: #e65100;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            font-weight: 500;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background: #ee5a6f;
            transform: translateY(-1px);
        }
        .btn-success {
            background: #2ed573;
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background: #26de81;
            transform: translateY(-1px);
        }
        .btn-logout {
            background: none;
            border: 2px solid white;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        .btn-logout:hover {
            background: rgba(255,255,255,0.1);
        }
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        select:hover {
            border-color: #cbd5e0;
        }
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        tr:hover {
            background: #f7fafc;
        }
        th {
            font-weight: 600;
            color: #2d3748;
        }
        .search-box {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            width: 300px;
            max-width: 100%;
            font-size: 1em;
            transition: all 0.3s;
        }
        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            flex: 1;
            min-width: 200px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #1a1a2e;
        }
        .stat-label {
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="admin-header-content">
            <div class="dashboard-logo">üõ°Ô∏è ADMIN MAJAY</div>
            <nav class="admin-nav">
                <a href="dashboard.html" class="nav-link">üìä Dashboard</a>
                <a href="vendeurs.html" class="nav-link active">üë• Vendeurs</a>
            </nav>
            <button onclick="deconnexionAdmin()" class="btn-logout">üö™ D√©connexion</button>
        </div>
    </header>

    <div class="dashboard-container">
        <!-- Statistiques rapides -->
        <div class="stats-row" id="statsRow">
            <div class="stat-card">
                <div class="stat-number" id="totalVendeurs">-</div>
                <div class="stat-label">Total Vendeurs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="vendeursActifs">-</div>
                <div class="stat-label">Actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="vendeursPro">-</div>
                <div class="stat-label">Plan Pro</div>
            </div>
        </div>

        <!-- Barre de recherche -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
            <h1 style="font-size: 2em; margin: 0;">Gestion des Vendeurs</h1>
            <input type="text" id="searchInput" class="search-box" placeholder="üîç Rechercher par nom, slug ou t√©l√©phone...">
        </div>

        <!-- Tableau des vendeurs -->
        <div style="background: white; border-radius: 16px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <table style="width: 100%; min-width: 900px;">
                <thead>
                    <tr style="background: #f7fafc;">
                        <th style="padding: 15px; text-align: left;">Vendeur</th>
                        <th style="padding: 15px; text-align: left;">Contact</th>
                        <th style="padding: 15px; text-align: left;">Plan</th>
                        <th style="padding: 15px; text-align: center;">Produits</th>
                        <th style="padding: 15px; text-align: center;">Statut</th>
                        <th style="padding: 15px; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody id="vendeursTable">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 60px; color: #718096;">
                            <div style="font-size: 3em;">‚è≥</div>
                            <div style="margin-top: 10px;">Chargement des donn√©es...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { supabase } from "../js/config.js";
        import { adminAuth } from "../js/admin-auth.js";

        // V√©rifier l'authentification
        const admin = adminAuth.verifierAuthAdmin();
        if (!admin) {
            window.location.href = 'connexion.html';
        }

        // Fonction de d√©connexion globale
        window.deconnexionAdmin = () => {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                adminAuth.deconnexionAdmin();
            }
        };

        let stores = [];
        let stats = { total: 0, actifs: 0, pro: 0 };

        // Charger les boutiques
        async function chargerVendeurs() {
            try {
                stores = await adminAuth.getStores();
                
                // Enrichir avec le nombre de produits
                for (let store of stores) {
                    const { count } = await supabase
                        .from('products')
                        .select('*', { count: 'exact', head: true })
                        .eq('store_id', store.id)
                        .eq('is_active', true);
                    store.nombreProduits = count || 0;
                }
                
                calculerStats();
                afficherVendeurs(stores);
            } catch (error) {
                console.error('Erreur chargement:', error);
                document.getElementById('vendeursTable').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 60px;">
                            <div style="color: #ff4757; font-size: 3em;">‚ùå</div>
                            <div style="color: #ff4757; margin-top: 10px; font-weight: 600;">Erreur lors du chargement</div>
                            <div style="color: #718096; margin-top: 5px;">${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }

        // Calculer les statistiques
        function calculerStats() {
            stats.total = stores.length;
            stats.actifs = stores.filter(s => s.is_active).length;
            stats.pro = stores.filter(s => s.subscription_plan === 'pro' || s.subscription_plan === 'entreprise').length;
            
            document.getElementById('totalVendeurs').textContent = stats.total;
            document.getElementById('vendeursActifs').textContent = stats.actifs;
            document.getElementById('vendeursPro').textContent = stats.pro;
        }

        // Afficher les boutiques dans le tableau
        function afficherVendeurs(liste) {
            if (liste.length === 0) {
                document.getElementById('vendeursTable').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 60px; color: #718096;">
                            <div style="font-size: 3em;">üîç</div>
                            <div style="margin-top: 10px;">Aucune boutique trouv√©e</div>
                        </td>
                    </tr>
                `;
                return;
            }

            document.getElementById('vendeursTable').innerHTML = liste.map(store => {
                const owner = Array.isArray(store.owner) ? store.owner[0] : store.owner;
                return `
                <tr style="border-top: 1px solid #e2e8f0;">
                    <td style="padding: 15px;">
                        <div style="font-weight: 600; color: #2d3748;">${store.name}</div>
                        <div style="color: #718096; font-size: 0.9em; margin-top: 3px;">@${store.slug}</div>
                    </td>
                    <td style="padding: 15px;">
                        <div style="color: #2d3748;">${owner?.phone || 'N/A'}</div>
                        ${owner?.full_name ? `<div style="color: #718096; font-size: 0.9em; margin-top: 3px;">${owner.full_name}</div>` : ''}
                    </td>
                    <td style="padding: 15px;">
                        <select onchange="changerPlan('${store.id}', this.value, this)" 
                                style="padding: 8px 12px; border-radius: 8px; border: 2px solid #e2e8f0; background: white;">
                            <option value="free" ${store.subscription_plan === 'free' ? 'selected' : ''}>üéÅ Free</option>
                            <option value="pro" ${store.subscription_plan === 'pro' ? 'selected' : ''}>‚≠ê Pro</option>
                            <option value="entreprise" ${store.subscription_plan === 'entreprise' ? 'selected' : ''}>üè¢ Entreprise</option>
                        </select>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <span style="font-weight: 600; color: #667eea;">${store.nombreProduits || 0}</span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <span class="badge ${store.is_active ? 'badge-active' : 'badge-inactive'}">
                            ${store.is_active ? '‚úì Actif' : '‚úó Inactif'}
                        </span>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <button class="btn ${store.is_active ? 'btn-danger' : 'btn-success'}" 
                                onclick="${store.is_active ? 'desactiverVendeur' : 'activerVendeur'}('${store.id}', this)">
                            ${store.is_active ? 'üö´ D√©sactiver' : '‚úì Activer'}
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Changer le plan d'une boutique
        window.changerPlan = async (storeId, nouveauPlan, selectElement) => {
            const store = stores.find(s => s.id === storeId);
            const ancienPlan = store?.subscription_plan || 'free';
            selectElement.disabled = true;
            
            try {
                await adminAuth.changerPlan(storeId, nouveauPlan);
                const planNames = { free: 'Free üéÅ', pro: 'Pro ‚≠ê', entreprise: 'Entreprise üè¢' };
                alert(`‚úÖ Plan modifi√© avec succ√®s vers ${planNames[nouveauPlan] || nouveauPlan} !`);
                await chargerVendeurs();
            } catch (error) {
                alert('‚ùå Erreur lors de la modification du plan: ' + error.message);
                console.error(error);
                selectElement.value = ancienPlan;
                selectElement.disabled = false;
            }
        };

        // D√©sactiver une boutique
        window.desactiverVendeur = async (storeId, btnElement) => {
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir d√©sactiver cette boutique ?\n\nSon catalogue ne sera plus accessible publiquement.')) {
                return;
            }
            
            btnElement.disabled = true;
            btnElement.textContent = '‚è≥ D√©sactivation...';
            
            try {
                await adminAuth.toggleStore(storeId, false);
                alert('‚úÖ Boutique d√©sactiv√©e avec succ√®s !');
                await chargerVendeurs();
            } catch (error) {
                alert('‚ùå Erreur lors de la d√©sactivation: ' + error.message);
                console.error(error);
                btnElement.disabled = false;
                btnElement.textContent = 'üö´ D√©sactiver';
            }
        };

        // Activer une boutique
        window.activerVendeur = async (storeId, btnElement) => {
            btnElement.disabled = true;
            btnElement.textContent = '‚è≥ Activation...';
            
            try {
                await adminAuth.toggleStore(storeId, true);
                alert('‚úÖ Boutique activ√©e avec succ√®s !');
                await chargerVendeurs();
            } catch (error) {
                alert('‚ùå Erreur lors de l\'activation: ' + error.message);
                console.error(error);
                btnElement.disabled = false;
                btnElement.textContent = '‚úì Activer';
            }
        };

        // Fonction de recherche
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const terme = e.target.value.toLowerCase().trim();
            
            if (!terme) {
                afficherVendeurs(stores);
                return;
            }
            
            const filtres = stores.filter(store => {
                const owner = Array.isArray(store.owner) ? store.owner[0] : store.owner;
                return store.name.toLowerCase().includes(terme) || 
                       store.slug.toLowerCase().includes(terme) ||
                       (owner?.phone && owner.phone.includes(terme)) ||
                       (owner?.full_name && owner.full_name.toLowerCase().includes(terme));
            });
            
            afficherVendeurs(filtres);
        });

        // Charger les vendeurs au d√©marrage
        chargerVendeurs();
    </script>
</body>
</html>